<!doctype html>
<html>
    <head>
        <title>LoGF</title>
        <link rel="stylesheet" type="text/css" href="/assets/css/vis-network.min.css">
        <!-- <link rel="stylesheet" type="text/css" href="/assets/css/main.css"> -->
        <link rel="stylesheet" type="text/css" href="/assets/css/custom.css">
    </head>
    <body>
        <div id="graph">
            <div id="nameForm">
                <h1>Please enter your name</h1>
                <input placeholder=" Start from p04"></input>
                <input placeholder=" Start from p07"></input><br>
                <input placeholder=" Start from p17"></input>
                <input placeholder=" Start from p21"></input><br>
                <button onClick="submitName()">Send</button>
            </div>
        </div>
        <div id="infor">
            <h1>Game Log</h1>
            <div id="gameLog"></div>
            <h1>Node Info</h1>
            <div id="nodeInfo"></div>
        </div>
        
    </body>
</html>

<script type="text/javascript" src="/assets/lib/vis.js"></script>
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript">

    var socket = io.connect();

    // create a network
    var graph = document.getElementById('graph');
    var infor = document.getElementById('infor');
    var gameLog = document.getElementById('gameLog');
    var nodeInfo = document.getElementById('nodeInfo');
    var graphData = {};
    var options   = {
        // 'autoResize'  : true,
        'height'      : 'calc(100% - 2px)',
        'width'       : 'calc(100% - 1wpx)',
        'interaction' : { 'dragNodes':false },
        'edges'       : { 'width':2 },
        'physics'     : { 'enabled':false },
        'nodes'       : {
            'shape': 'dot',
            'size' : 30,
            'font' : {
                'size' : 32,
                'color': '#ffffff'
            },
            'borderWidth': 2,
            'chosen': { 'node':nodesOnClick  }
        }
    };
    var network, game;

    function nodesOnClick(values, id, selected, hovering) {
        values.size += 20;
        values.id  = id;
        values.color = '#ffffff'
        nodeInfo.innerHTML = JSON.stringify(values, null, 4).replace(/\n/g, "<br>").replace(/\"/g,'\'').replace(/ /g, '&nbsp;');
    }

    function showMessage(msg) {
        let time = new Date();
        gameLog.innerHTML = (`<text>${time.toLocaleTimeString()} | ${msg}</text><br>` + gameLog.innerHTML);
    }

    function submitName() {

        // Get value
        var inputs = $('#nameForm > input')
        var names = [
            inputs[0].value,
            inputs[1].value,
            inputs[2].value,
            inputs[3].value
        ]

        // Check if available
        let playerCount = 0;
        for(let i in names) if(names[i] !== '') playerCount++;
        if(!(playerCount >= 2 && playerCount <= 4)) {
            showMessage("玩家人數必須介於2~4之間");
            return;
        }
        socket.emit('start', {
            'type': 'start',
            'name': names
        })
    }

    socket.on('response', function(data) {
        console.log(data);
        if(data.type === undefined) return;
        adapter[data.type](data);
    })

    var adapter = {
        'start': function(data) {

            // Get game status
            game = data.game.game;

            // Draw graph
            graphData.nodes = new vis.DataSet(data.game.graphNodes);
            graphData.edges = new vis.DataSet(data.game.graphEdges);
            network = new vis.Network(graph, graphData, options);

            // Zoom in
            network.once("beforeDrawing", function() {
                network.focus('f08', { scale: 2 });
            });
            network.once("afterDrawing", function() {
                network.fit({
                    animation: {
                        duration: 3000,
                        easingFunction: 'linear'
                    }
                });
            });

            // Change interface
            showMessage('遊戲開始!!')
            $('#nameForm').hide();
        }
    }
    // this.selectionHandler.selectNodes.apply(this.selectionHandler, arguments)
    // network.selectionHandler.selectNodes.apply(network.selectionHandler, [['b02']])

</script>